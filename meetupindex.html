<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IITM BS | Meetup Verification</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection"></script>

    <style>
        :root {
            --iitm-blue: #002147;
            --iitm-gold: #f2b824;
            --light-bg: #f4f7f9;
            --success-green: #2ecc71;
            --error-red: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            width: 90%;
            max-width: 420px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            overflow: hidden;
            border-top: 6px solid var(--iitm-blue);
        }

        .header {
            background: var(--iitm-blue);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header img {
            width: 70px;
            margin-bottom: 10px;
        }

        .header h2 {
            margin: 0;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
        }

        .content {
            padding: 25px;
        }

        .step-box {
            background: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: 0.3s;
        }

        .step-box.active {
            border-color: var(--iitm-blue);
            box-shadow: 0 0 10px rgba(0,33,71,0.05);
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            background: #ccc;
        }

        .indicator.on { background: var(--success-green); box-shadow: 0 0 5px var(--success-green); }
        .indicator.off { background: var(--error-red); }

        video {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            background: #000;
            transform: scaleX(-1);
        }

        #submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--iitm-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        #submit-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        #submit-btn:hover:not(:disabled) {
            background: #003366;
        }

        .footer-text {
            text-align: center;
            font-size: 0.75rem;
            color: #777;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://study.iitm.ac.in/ds/assets/img/iitm-logo.png" alt="IITM Logo">
        <h2>Student Meetup Check-In</h2>
    </div>

    <div class="content">
        <div id="auth-section" class="step-box active">
            <p style="margin-top:0; font-weight:600;">Step 1: Authenticate</p>
            <div id="g_id_onload"
                 data-client_id="475935559046-g6de13oits2nbfg68gj1qanp370143cg.apps.googleusercontent.com"
                 data-callback="onSignIn">
            </div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>

        <div id="verify-section" class="step-box" style="display:none; opacity:0.5;">
            <p style="margin-top:0; font-weight:600;">Step 2: Presence Check</p>
            
            <div class="status-item">
                <div id="loc-ind" class="indicator"></div>
                <span id="loc-text">Checking Location...</span>
            </div>

            <div class="status-item">
                <div id="face-ind" class="indicator"></div>
                <span id="face-text">Initializing Camera...</span>
            </div>

            <video id="webcam" autoplay muted playsinline></video>
        </div>

        <button id="submit-btn" disabled onclick="submitData()">Confirm Attendance</button>
        <p class="footer-text">Restricted to @ds.study.iitm.ac.in accounts</p>
    </div>
</div>

<script>
    const APP_CONFIG = {
        CLIENT_ID: "475935559046-g6de13oits2nbfg68gj1qanp370143cg.apps.googleusercontent.com",
        API_URL: "https://script.google.com/macros/s/AKfycbyI7WjC8T8T7N1E-vM_Y5hVn0V1-v0X2b-j8_vB-p-x4_B-y1-v-V-I-z/exec", // Note: Ensure this is the EXEC URL, not the ECHO URL
        RADIUS: 100 
    };

    let state = {
        event: new URLSearchParams(window.location.search).get('event'),
        user: null,
        geo: false,
        face: false,
        coords: { lat: 0, lng: 0 },
        target: { lat: 0, lng: 0 }
    };

    async function onSignIn(response) {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        if (!payload.email.endsWith("@ds.study.iitm.ac.in")) {
            alert("Please use your student email ID.");
            return;
        }

        state.user = { name: payload.name, email: payload.email, sub: payload.sub };
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('verify-section').style.display = 'block';
        document.getElementById('verify-section').style.opacity = '1';
        
        loadEventDetails();
    }

    async function loadEventDetails() {
        if (!state.event) {
            alert("No Event ID found in URL. Use ?event=YOUR_ID");
            return;
        }
        
        try {
            const res = await fetch(`${APP_CONFIG.API_URL}?eventId=${state.event}`);
            const data = await res.json();
            state.target = { lat: data.lat, lng: data.lng };
            startVerification();
        } catch (e) {
            alert("Could not load event data from Google Sheets.");
        }
    }

    function startVerification() {
        // 1. Geo Tracking
        navigator.geolocation.watchPosition(pos => {
            state.coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            const dist = getDistance(state.coords.lat, state.coords.lng, state.target.lat, state.target.lng);
            state.geo = dist <= APP_CONFIG.RADIUS;
            
            const el = document.getElementById('loc-text');
            const ind = document.getElementById('loc-ind');
            el.innerText = state.geo ? "Location Verified" : `Too far (${Math.round(dist)}m)`;
            ind.className = `indicator ${state.geo ? 'on' : 'off'}`;
            validate();
        }, () => alert("Enable GPS to proceed"), { enableHighAccuracy: true });

        // 2. Face Detection
        setupFaceML();
    }

    async function setupFaceML() {
        const video = document.getElementById('webcam');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        const detector = await faceDetection.createDetector(
            faceDetection.SupportedModels.MediaPipeFaceDetection, 
            { runtime: 'mediapipe', solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/face_detection' }
        );

        setInterval(async () => {
            const faces = await detector.estimateFaces(video);
            state.face = faces.length > 0;
            const el = document.getElementById('face-text');
            const ind = document.getElementById('face-ind');
            el.innerText = state.face ? "Face Detected" : "Align face in camera";
            ind.className = `indicator ${state.face ? 'on' : 'off'}`;
            validate();
        }, 800);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function validate() {
        document.getElementById('submit-btn').disabled = !(state.geo && state.face);
    }

    async function submitData() {
        const btn = document.getElementById('submit-btn');
        btn.innerText = "Processing...";
        btn.disabled = true;

        const payload = {
            ...state.user,
            lat: state.coords.lat,
            lng: state.coords.lng,
            eventId: state.event
        };

        fetch(APP_CONFIG.API_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        }).then(() => {
            alert("Verification Complete! Enjoy the meetup.");
            window.location.reload();
        });
    }
</script>

</body>
</html>